<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>隔板突破器</title>
    <link href="bootstrap.min-4.5.3.css" rel="stylesheet">
    <style>
    .jumbotron {
        width: 100%;
    }
 
    #text {
        height: 3rem;
        font-size: 1rem;
        line-height: 3rem;
        margin: 1rem;
    }
 
    .btn {
        margin-right: 5px;
    }
 
    #connect {
        margin-left: 1rem;
    }
 
    #log {
        margin: 1rem 0 0 1rem;
    }
 
</style>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="jumbotron col-lg-10">
            <div class="form-inline">
	            <button type="button" class="btn btn-danger my-1 ml-3" id="disconnect" disabled="disabled">離線</button>
	            <label class="my-1 ml-2 mr-1" for="room">Room:</label>
	            <select id="room" class="custom-select my-1">
	                <option value="001">001</option>
	                <option value="002">002</option>
	                <option value="003">003</option>
	                <option value="004">004</option>
	                <option value="005">005</option>
	                <option value="006">006</option>
	            </select>
	            <label class="my-1 ml-2 mr-1" for="name">Name:</label>
	            <input type="text" id="name" class="form-control">
	            <button type="button" class="btn btn-info my-1" id="connect">連接</button>
	            <button type="button" class="btn btn-outline-secondary my-1" id="clear">清除</button>
            </div>
            <div id="log" style="height:500px;overflow-y:auto;">
                <p>對話紀錄:</p>
            </div>
            <input type="text" id="text" class="col-lg-10"/>
            <input type="button" value="發送" class="btn btn-success" id="sent" disabled="disabled"/>
        </div>
	    <div class="col-lg-2">
	        <table class="table table-striped" id="onlineList">
	            <thead class="thead-dark">
	                <tr>
	                    <th scope="col">在線清單</th>
	                </tr>
	            </thead>
	        </table>
	    </div>
    </div>
</div>
</body>
<!--<script src="https://cdn.bootcss.com/sockjs-client/0.3.4/sockjs.min.js"></script>-->
<script type="text/javascript">

	var ws;
    var connect = function () {
    	let roomNum = document.querySelector('#room').value;
	    let name = document.querySelector('#name').value;
	    if (!name) {
	    	log('尚未輸入Name!', 'sys');
	    	return;
	    }
	    
	    //ws = new SockJS("/connect/" + roomNum );
	    ws = new WebSocket('ws://10.2.60.47:8080/connect/' + roomNum + '?name='+name);
	    ws.onopen = function () {
	        setConnected(true);
	        //setName();
	        log('伺服器連接成功！', 'sys');
	    };
	    ws.onmessage = function (event) {
	        log(event.data, 'msg');
	    };
	    ws.onclose = function () {
	        setConnected(false);
	        log('伺服器連接中斷！', 'sys')
	    }
	}

    let text = document.querySelector('#text');
    let connectBtn = document.querySelector("#connect");
    let sentBtn = document.querySelector("#sent");
    let disconnectBtn = document.querySelector("#disconnect");
    let clearBtn = document.querySelector("#clear");
    let logDiv = document.querySelector("#log");
    let roomSelect = document.querySelector("#room");
    let nameInput = document.querySelector("#name");
 
    var sent = function () {
        if (text.value == '') {
        	return;
        }
    	
    	if (ws != null) {
            ws.send(text.value);
            text.value = '';
        } else {
            log('尚未連接！', 'sys')
        }
    }
 
    var disconnect = function () {
        if (ws != null) {
            ws.close();
            ws = null;
        }
        setConnected(false);
    }
 
    var log = function (value, type) {
    	
    	let sentMsg;
    	let sentDate;
    	let sentName;
    	let sentType;
    	
    	if (type == 'msg') {
    		let json = JSON.parse(value);
    		sentMsg = json.sentMsg;
    		sentDate = json.sentDate;
    		sentName = json.sentName;
    		sentType = json.sentType;
    	} else {
    		sentMsg = value;
    		sentDate = getTime();
    		sentType = 'SYS';
    	}
    	
    	if (sentType == 'LIST') {
    		updateOnlinelist(sentMsg);
    		return;
    	}
    	
        let content = document.createElement('div');
        content.style['word-break'] = 'break-word';
        if (sentType == 'SYS' ) {
        	content.style.color = 'red';
        }
        
        let outputMsg;
        outputMsg = sentDate + ' ';
        if (sentName) {
        	outputMsg = outputMsg + sentName + ': '; 
        }
        outputMsg = outputMsg + sentMsg;
        
        content.textContent = outputMsg;
        logDiv.appendChild(content);
        logDiv.scrollTop = logDiv.scrollHeight;
    	
    }
    
    var getTime = function(){
    	var now = new Date();
    	return timeFormat(now.getHours()) + ':' + timeFormat(now.getMinutes()) + ':' + timeFormat(now.getSeconds());
    }
    
    var timeFormat = function(timeData){
        if (timeData / 10 < 1) {
        	return "0" + timeData;
        }
        return timeData;
    }
 
    var setConnected = function (connected) {
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
        sentBtn.disabled = !connected;
        roomSelect.disabled = connected;
        nameInput.disabled = connected;
    }
    
    var updateOnlinelist = function (value) {
    	let onlineList = document.querySelector('#onlineList');
    	let tbody = onlineList.querySelector('tbody');
    	if(tbody){
    		tbody.remove();
    	}
    	let newTbody = document.createElement('tbody');
    	
    	let clientList = Object.values(JSON.parse(value));
    	clientList.forEach(client => {
    		let tr = document.createElement('tr');
    		let td = document.createElement('td');
    		td.textContent = client;
    		tr.appendChild(td);
    		newTbody.appendChild(tr);
    	});
    	
    	onlineList.appendChild(newTbody);
    }
    
    
    connectBtn.onclick = function(){
    	connect();
    };
    
    sentBtn.onclick = function(){
    	sent();
    };
    
    disconnectBtn.onclick = function(){
    	disconnect();
    };
    
    clearBtn.onclick = function(){
    	logDiv.innerHTML = '';
    };
    
    document.addEventListener('keyup', (e) => {
        if ((e.key == 'Enter')){
        	sent();
        }
    });
</script>
</html>